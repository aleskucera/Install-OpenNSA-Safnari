---
# PostgreSQL
- name: Create PostgreSQL database
  postgresql_db:
    name: "{{ databases.opennsa }}"
    state: present
  become_user: postgres
  register: db_state
  tags: [ postgresql ]
  
- name: Grant privileges to the database
  postgresql_privs:
    type: database
    database: "{{ databases.opennsa }}"
    roles: "{{ postgres_user }}"
    grant_option: no
    privs: all
  become_user: postgres
  tags: [ postgresql ]

- name: Run queries from SQL script
  community.postgresql.postgresql_query:
    db: "{{ databases.opennsa }}"
    path_to_script: "{{ repos.opennsa.folder }}/opennsa/datafiles/schema.sql"
    as_single_query: yes
  become_user: postgres
  when: db_state.changed
  notify: 
    - Restart PostgreSQL
  tags: [ postgresql ]